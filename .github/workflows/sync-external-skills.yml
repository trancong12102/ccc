name: Sync External Skills

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: "0 0 * * *"
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Update submodules
        run: |
          git submodule update --remote --merge

      - name: Sync external skills
        run: bash scripts/sync-external.sh

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet external/; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Bump ccc-external version
        if: steps.changes.outputs.changed == 'true'
        run: |
          # Extract current version and bump patch
          current_version=$(jq -r '.plugins[] | select(.name == "ccc-external") | .version' .claude-plugin/marketplace.json)
          IFS='.' read -r major minor patch <<< "$current_version"
          new_version="$major.$minor.$((patch + 1))"

          # Update version in marketplace.json
          jq --arg new_version "$new_version" '
            .plugins = [.plugins[] | if .name == "ccc-external" then .version = $new_version else . end]
          ' .claude-plugin/marketplace.json > tmp.json && mv tmp.json .claude-plugin/marketplace.json

          echo "Bumped ccc-external version from $current_version to $new_version"

      - name: Commit and push
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add external/ .claude-plugin/marketplace.json
          git commit -m "chore(external): sync external skills from submodules"
          git push
